function MediumEditor(t,e){"use strict";return this.init(t,e)}"object"==typeof module?module.exports=MediumEditor:"function"==typeof define&&define.amd&&define(function(){"use strict";return MediumEditor}),function(t,e){"use strict";function o(t,e){var o;if(void 0===t)return e;for(o in e)e.hasOwnProperty(o)&&t.hasOwnProperty(o)===!1&&(t[o]=e[o]);return t}function n(t,e){var o,n,i,s,a=50,r=null,l=0;return e||0===e||(e=a),s=function(){l=d(),r=null,i=t.apply(o,n),r||(o=n=null)},function(){var a=d(),c=e-(a-l);return o=this,n=arguments,0>=c||c>e?(clearTimeout(r),r=null,l=a,i=t.apply(o,n),r||(o=n=null)):r||(r=setTimeout(s,c)),i}}function i(t,e){for(var o=e.parentNode;null!==o;){if(o===t)return!0;o=o.parentNode}return!1}function s(t,e,o){var n,i=!1,s=o.createNodeIterator(t,NodeFilter.SHOW_TEXT,null,!1);for(n=s.nextNode();n;){if(n===e)i=!0;else if(i&&3===n.nodeType&&n.nodeValue&&n.nodeValue.trim().length>0)break;n=s.nextNode()}return n}function a(){var t,e,o,n=this.options.contentWindow.getSelection();if(n.getRangeAt&&n.rangeCount){for(o=[],t=0,e=n.rangeCount;e>t;t+=1)o.push(n.getRangeAt(t));return o}return null}function r(t){var e,o,n=this.options.contentWindow.getSelection();if(t)for(n.removeAllRanges(),e=0,o=t.length;o>e;e+=1)n.addRange(t[e])}function l(){var t=this.options.ownerDocument.getSelection().anchorNode,e=t&&3===t.nodeType?t.parentNode:t;return e}function c(){var t,e,o,n,i="";if(void 0!==this.options.contentWindow.getSelection){if(e=this.options.contentWindow.getSelection(),e.rangeCount){for(n=this.options.ownerDocument.createElement("div"),t=0,o=e.rangeCount;o>t;t+=1)n.appendChild(e.getRangeAt(t).cloneContents());i=n.innerHTML}}else void 0!==this.options.ownerDocument.selection&&"Text"===this.options.ownerDocument.selection.type&&(i=this.options.ownerDocument.selection.createRange().htmlText);return i}function h(e,o){var n,i;return o||(o=t.getSelection().getRangeAt(0)),n=o.cloneRange(),i=o.cloneRange(),n.selectNodeContents(e),n.setEnd(o.endContainer,o.endOffset),i.selectNodeContents(e),i.setStart(o.endContainer,o.endOffset),{left:n.toString().length,right:i.toString().length}}function u(t){return!(!t||1!==t.nodeType)}var d,p,m,f={bold:{name:"bold",action:"bold",aria:"bold",tagNames:["b","strong"],contentDefault:"<b>B</b>",contentFA:'<i class="fa fa-bold"></i>'},italic:{name:"italic",action:"italic",aria:"italic",tagNames:["i","em"],style:{prop:"font-style",value:"italic"},contentDefault:"<b><i>I</i></b>",contentFA:'<i class="fa fa-italic"></i>'},underline:{name:"underline",action:"underline",aria:"underline",tagNames:["u"],contentDefault:"<b><u>U</u></b>",contentFA:'<i class="fa fa-underline"></i>'},strikethrough:{name:"strikethrough",action:"strikethrough",aria:"strike through",tagNames:["strike"],contentDefault:"<s>A</s>",contentFA:'<i class="fa fa-strikethrough"></i>'},superscript:{name:"superscript",action:"superscript",aria:"superscript",tagNames:["sup"],contentDefault:"<b>x<sup>1</sup></b>",contentFA:'<i class="fa fa-superscript"></i>'},subscript:{name:"subscript",action:"subscript",aria:"subscript",tagNames:["sub"],contentDefault:"<b>x<sub>1</sub></b>",contentFA:'<i class="fa fa-subscript"></i>'},anchor:{name:"anchor",action:"anchor",aria:"link",tagNames:["a"],contentDefault:"<b>#</b>",contentFA:'<i class="fa fa-link"></i>'},image:{name:"image",action:"image",aria:"image",tagNames:["img"],contentDefault:"<b>image</b>",contentFA:'<i class="fa fa-picture-o"></i>'},quote:{name:"quote",action:"append-blockquote",aria:"blockquote",tagNames:["blockquote"],contentDefault:"<b>&ldquo;</b>",contentFA:'<i class="fa fa-quote-right"></i>'},orderedlist:{name:"orderedlist",action:"insertorderedlist",aria:"ordered list",tagNames:["ol"],contentDefault:"<b>1.</b>",contentFA:'<i class="fa fa-list-ol"></i>'},unorderedlist:{name:"unorderedlist",action:"insertunorderedlist",aria:"unordered list",tagNames:["ul"],contentDefault:"<b>&bull;</b>",contentFA:'<i class="fa fa-list-ul"></i>'},pre:{name:"pre",action:"append-pre",aria:"preformatted text",tagNames:["pre"],contentDefault:"<b>0101</b>",contentFA:'<i class="fa fa-code fa-lg"></i>'},indent:{name:"indent",action:"indent",aria:"indent",tagNames:[],contentDefault:"<b>&rarr;</b>",contentFA:'<i class="fa fa-indent"></i>'},outdent:{name:"outdent",action:"outdent",aria:"outdent",tagNames:[],contentDefault:"<b>&larr;</b>",contentFA:'<i class="fa fa-outdent"></i>'},justifyCenter:{name:"justifyCenter",action:"justifyCenter",aria:"center justify",tagNames:[],style:{prop:"text-align",value:"center"},contentDefault:"<b>C</b>",contentFA:'<i class="fa fa-align-center"></i>'},justifyFull:{name:"justifyFull",action:"justifyFull",aria:"full justify",tagNames:[],style:{prop:"text-align",value:"justify"},contentDefault:"<b>J</b>",contentFA:'<i class="fa fa-align-justify"></i>'},justifyLeft:{name:"justifyLeft",action:"justifyLeft",aria:"left justify",tagNames:[],style:{prop:"text-align",value:"left"},contentDefault:"<b>L</b>",contentFA:'<i class="fa fa-align-left"></i>'},justifyRight:{name:"justifyRight",action:"justifyRight",aria:"right justify",tagNames:[],style:{prop:"text-align",value:"right"},contentDefault:"<b>R</b>",contentFA:'<i class="fa fa-align-right"></i>'},header1:{name:"header1",action:function(t){return"append-"+t.firstHeader},aria:function(t){return t.firstHeader},tagNames:function(t){return[t.firstHeader]},contentDefault:"<b>H1</b>"},header2:{name:"header2",action:function(t){return"append-"+t.secondHeader},aria:function(t){return t.secondHeader},tagNames:function(t){return[t.secondHeader]},contentDefault:"<b>H2</b>"}};m=function(t,e){this.options=t,this.name=t.name,this.init(e)},m.prototype={init:function(t){this.base=t,this.button=this.createButton(),this.base.on(this.button,"click",this.handleClick.bind(this))},getButton:function(){return this.button},getAction:function(){return"function"==typeof this.options.action?this.options.action(this.base.options):this.options.action},getAria:function(){return"function"==typeof this.options.aria?this.options.aria(this.base.options):this.options.aria},getTagNames:function(){return"function"==typeof this.options.tagNames?this.options.tagNames(this.base.options):this.options.tagNames},createButton:function(){var t=this.base.options.ownerDocument.createElement("button"),e=this.options.contentDefault;return t.classList.add("medium-editor-action"),t.classList.add("medium-editor-action-"+this.name),t.setAttribute("data-action",this.getAction()),t.setAttribute("aria-label",this.getAria()),this.base.options.buttonLabels&&("fontawesome"===this.base.options.buttonLabels&&this.options.contentFA?e=this.options.contentFA:"object"==typeof this.base.options.buttonLabels&&this.base.options.buttonLabels[this.name]&&(e=this.base.options.buttonLabels[this.options.name])),t.innerHTML=e,t},handleClick:function(t){t.preventDefault(),t.stopPropagation();var e=this.getAction();this.base.selection||this.base.checkSelection(),this.isActive()?this.deactivate():this.activate(),e&&this.base.execAction(e,t)},isActive:function(){return this.button.classList.contains(this.base.options.activeButtonClass)},deactivate:function(){this.button.classList.remove(this.base.options.activeButtonClass),delete this.knownState},activate:function(){this.button.classList.add(this.base.options.activeButtonClass),delete this.knownState},shouldActivate:function(t){var e=!1,o=this.getTagNames();return this.knownState===!1||this.knownState===!0?this.knownState:(o&&o.length>0&&t.tagName&&(e=-1!==o.indexOf(t.tagName.toLowerCase())),!e&&this.options.style&&(this.knownState=e=-1!==this.base.options.contentWindow.getComputedStyle(t,null).getPropertyValue(this.options.style.prop).indexOf(this.options.style.value)),e)}},d=Date.now||function(){return(new Date).getTime()},p={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,DELETE:46},MediumEditor.statics={ButtonsData:f,DefaultButton:m},MediumEditor.prototype={defaults:{allowMultiParagraphSelection:!0,anchorInputPlaceholder:"Paste or type a link",anchorInputCheckboxLabel:"Open in new window",anchorPreviewHideDelay:500,buttons:["bold","italic","underline","anchor","header1","header2","quote"],buttonLabels:!1,checkLinkFormat:!1,cleanPastedHTML:!1,delay:0,diffLeft:0,diffTop:-10,disableReturn:!1,disableDoubleReturn:!1,disableToolbar:!1,disableEditing:!1,disableAnchorForm:!1,disablePlaceholders:!1,elementsContainer:!1,imageDragging:!0,standardizeSelectionStart:!1,contentWindow:t,ownerDocument:e,firstHeader:"h3",forcePlainText:!0,placeholder:"Type your text",secondHeader:"h4",targetBlank:!1,anchorTarget:!1,anchorButton:!1,anchorButtonClass:"btn",extensions:{},activeButtonClass:"medium-editor-button-active",firstButtonClass:"medium-editor-button-first",lastButtonClass:"medium-editor-button-last"},isIE:"Microsoft Internet Explorer"===navigator.appName||"Netscape"===navigator.appName&&null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),init:function(t,e){var n=1;if(this.options=o(e,this.defaults),this.setElementSelection(t),0!==this.elements.length){for(this.parentElements=["p","h1","h2","h3","h4","h5","h6","blockquote","pre"],this.options.elementsContainer||(this.options.elementsContainer=this.options.ownerDocument.body);this.options.elementsContainer.querySelector("#medium-editor-toolbar-"+n);)n+=1;return this.id=n,this.setup()}},setup:function(){this.events=[],this.isActive=!0,this.initThrottledMethods().initCommands().initElements().bindSelect().bindDragDrop().bindPaste().setPlaceholders().bindElementActions().bindWindowActions()},on:function(t,e,o,n){t.addEventListener(e,o,n),this.events.push([t,e,o,n])},off:function(t,e,o,n){var i,s=this.indexOfListener(t,e,o,n);-1!==s&&(i=this.events.splice(s,1)[0],i[0].removeEventListener(i[1],i[2],i[3]))},indexOfListener:function(t,e,o,n){var i,s,a;for(i=0,s=this.events.length;s>i;i+=1)if(a=this.events[i],a[0]===t&&a[1]===e&&a[2]===o&&a[3]===n)return i;return-1},delay:function(t){var e=this;setTimeout(function(){e.isActive&&t()},this.options.delay)},removeAllEvents:function(){for(var t=this.events.pop();t;)t[0].removeEventListener(t[1],t[2],t[3]),t=this.events.pop()},initThrottledMethods:function(){var t=this;return this.handleResize=n(function(){t.isActive&&t.positionToolbarIfShown()}),this.handleBlur=n(function(){t.isActive&&!t.keepToolbarAlive&&t.hideToolbarActions()}),this},initElements:function(){var t,e=!1;for(t=0;t<this.elements.length;t+=1)this.options.disableEditing||this.elements[t].getAttribute("data-disable-editing")||this.elements[t].setAttribute("contentEditable",!0),this.elements[t].getAttribute("data-placeholder")||this.elements[t].setAttribute("data-placeholder",this.options.placeholder),this.elements[t].setAttribute("data-medium-element",!0),this.elements[t].setAttribute("role","textbox"),this.elements[t].setAttribute("aria-multiline",!0),this.bindParagraphCreation(t),this.options.disableToolbar||this.elements[t].getAttribute("data-disable-toolbar")||(e=!0);return e&&this.initToolbar().bindButtons().bindAnchorForm().bindAnchorPreview(),this},setElementSelection:function(t){t||(t=[]),"string"==typeof t&&(t=this.options.ownerDocument.querySelectorAll(t)),u(t)&&(t=[t]),this.elements=Array.prototype.slice.apply(t)},bindBlur:function(){var t=this,e=function(e){var o,n=!1;for(o=0;o<t.elements.length;o+=1)if(i(t.elements[o],e.target)){n=!0;break}e.target===t.toolbar||-1!==t.elements.indexOf(e.target)||n||i(t.toolbar,e.target)||i(t.anchorPreview,e.target)||(t.options.disablePlaceholders||t.placeholderWrapper(e,t.elements[0]),t.handleBlur())};return this.on(this.options.ownerDocument.body,"click",e,!0),this.on(this.options.ownerDocument.body,"focus",e,!0),this},bindClick:function(t){var e=this;return this.on(this.elements[t],"click",function(){e.options.disablePlaceholders||this.classList.remove("medium-editor-placeholder"),e.options.staticToolbar&&e.setToolbarPosition()}),this},bindElementActions:function(){var t;for(t=0;t<this.elements.length;t+=1)this.options.disablePlaceholders||this.activatePlaceholder(this.elements[t]),this.bindReturn(t).bindKeydown(t).bindClick(t);return this},activatePlaceholder:function(t){t.querySelector("img")||t.querySelector("blockquote")||""!==t.textContent.replace(/^\s+|\s+$/g,"")||t.classList.add("medium-editor-placeholder")},placeholderWrapper:function(t,e){e=e||t.target,e.classList.remove("medium-editor-placeholder"),"keypress"!==t.type&&this.activatePlaceholder(e)},serialize:function(){var t,e,o={};for(t=0;t<this.elements.length;t+=1)e=""!==this.elements[t].id?this.elements[t].id:"element-"+t,o[e]={value:this.elements[t].innerHTML.trim()};return o},initExtension:function(t,e){return t.parent&&(t.base=this),"function"==typeof t.init&&t.init(this),t.name||(t.name=e),t},initCommands:function(){var t,e,o=this.options.buttons,n=this.options.extensions;this.commands=[],o.forEach(function(e){n[e]?(t=this.initExtension(n[e],e),this.commands.push(t)):f.hasOwnProperty(e)&&(t=new m(f[e],this),this.commands.push(t))}.bind(this));for(e in n)n.hasOwnProperty(e)&&-1===o.indexOf(e)&&(t=this.initExtension(n[e],e));return this},callExtensions:function(t){if(!(arguments.length<1)){var e,o,n=Array.prototype.slice.call(arguments,1);for(o in this.options.extensions)this.options.extensions.hasOwnProperty(o)&&(e=this.options.extensions[o],void 0!==e[t]&&e[t].apply(e,n));return this}},bindParagraphCreation:function(t){var e=this;return this.on(this.elements[t],"keypress",function(t){var o,n;t.which===p.SPACE&&(o=l.call(e),n=o.tagName.toLowerCase(),"a"===n&&e.options.ownerDocument.execCommand("unlink",!1,null))}),this.on(this.elements[t],"keyup",function(t){var o,n,i=l.call(e);i&&i.getAttribute("data-medium-element")&&0===i.children.length&&!e.options.disableReturn&&!i.getAttribute("data-disable-return")&&e.options.ownerDocument.execCommand("formatBlock",!1,"p"),t.which===p.ENTER&&(i=l.call(e),o=i.tagName.toLowerCase(),n=e.getSelectionElement(),e.options.disableReturn||n.getAttribute("data-disable-return")||"li"===o||e.isListItemChild(i)||(t.shiftKey||/h\d/.test(o)||e.options.ownerDocument.execCommand("formatBlock",!1,"p"),"a"===o&&e.options.ownerDocument.execCommand("unlink",!1,null)))}),this},isListItemChild:function(t){for(var e=t.parentNode,o=e.tagName.toLowerCase();-1===this.parentElements.indexOf(o)&&"div"!==o;){if("li"===o)return!0;if(e=e.parentNode,!e||!e.tagName)return!1;o=e.tagName.toLowerCase()}return!1},bindReturn:function(t){var e=this;return this.on(this.elements[t],"keypress",function(t){if(t.which===p.ENTER)if(e.options.disableReturn||this.getAttribute("data-disable-return"))t.preventDefault();else if(e.options.disableDoubleReturn||this.getAttribute("data-disable-double-return")){var o=l.call(e);o&&"\n"===o.textContent&&t.preventDefault()}}),this},bindKeydown:function(t){var e=this;return this.on(this.elements[t],"keydown",function(t){if(t.which===p.TAB){var o=l.call(e)||t.target,n=o&&o.tagName.toLowerCase();"pre"===n&&(t.preventDefault(),e.options.ownerDocument.execCommand("insertHtml",null,"    ")),("li"===n||e.isListItemChild(o))&&(t.preventDefault(),t.shiftKey?e.options.ownerDocument.execCommand("outdent",t):e.options.ownerDocument.execCommand("indent",t))}else(t.which===p.BACKSPACE||t.which===p.DELETE||t.which===p.ENTER)&&e.onBlockModifier(t)}),this},onBlockModifier:function(o){var n,i,s,a=l.call(this),r=a.tagName.toLowerCase(),c=/^(\s+|<br\/?>)?$/i,u=/h\d/i;(o.which===p.BACKSPACE||o.which===p.ENTER)&&a.previousElementSibling&&u.test(r)&&0===h(a).left?o.which===p.BACKSPACE&&c.test(a.previousElementSibling.innerHTML)?(a.previousElementSibling.parentNode.removeChild(a.previousElementSibling),o.preventDefault()):o.which===p.ENTER&&(s=this.options.ownerDocument.createElement("p"),s.innerHTML="<br>",a.previousElementSibling.parentNode.insertBefore(s,a),o.preventDefault()):o.which===p.DELETE&&a.nextElementSibling&&a.previousElementSibling&&!u.test(r)&&c.test(a.innerHTML)&&u.test(a.nextElementSibling.tagName)&&(n=e.createRange(),i=t.getSelection(),n.setStart(a.nextElementSibling,0),n.collapse(!0),i.removeAllRanges(),i.addRange(n),a.previousElementSibling.parentNode.removeChild(a),o.preventDefault())},initToolbar:function(){return this.toolbar?this:(this.toolbar=this.createToolbar(),this.keepToolbarAlive=!1,this.toolbarActions=this.toolbar.querySelector(".medium-editor-toolbar-actions"),this.anchorPreview=this.createAnchorPreview(),this.options.disableAnchorForm||(this.anchorForm=this.toolbar.querySelector(".medium-editor-toolbar-form"),this.anchorInput=this.anchorForm.querySelector("input.medium-editor-toolbar-input"),this.anchorTarget=this.anchorForm.querySelector("input.medium-editor-toolbar-anchor-target"),this.anchorButton=this.anchorForm.querySelector("input.medium-editor-toolbar-anchor-button")),this.addExtensionForms(),this)},createToolbar:function(){var t=this.options.ownerDocument.createElement("div");return t.id="medium-editor-toolbar-"+this.id,t.className="medium-editor-toolbar",t.className+=this.options.staticToolbar?" static-toolbar":" stalker-toolbar",t.appendChild(this.toolbarButtons()),this.options.disableAnchorForm||t.appendChild(this.toolbarFormAnchor()),this.options.elementsContainer.appendChild(t),t},toolbarButtons:function(){var t,e,o=this.options.ownerDocument.createElement("ul");return o.id="medium-editor-toolbar-actions"+this.id,o.className="medium-editor-toolbar-actions clearfix",this.commands.forEach(function(n){"function"==typeof n.getButton&&(e=n.getButton(this),t=this.options.ownerDocument.createElement("li"),u(e)?t.appendChild(e):t.innerHTML=e,o.appendChild(t))}.bind(this)),o},addExtensionForms:function(){var t,e;this.commands.forEach(function(o){o.hasForm&&(t="function"==typeof o.getForm?o.getForm():null),t&&(e="medium-editor-toolbar-form-"+o.name+"-"+this.id,t.className+=" medium-editor-toolbar-form",t.id=e,this.toolbar.appendChild(t))}.bind(this))},toolbarFormAnchor:function(){var t=this.options.ownerDocument.createElement("div"),e=this.options.ownerDocument.createElement("input"),o=this.options.ownerDocument.createElement("label"),n=this.options.ownerDocument.createElement("input"),i=this.options.ownerDocument.createElement("label"),s=this.options.ownerDocument.createElement("input"),a=this.options.ownerDocument.createElement("a"),r=this.options.ownerDocument.createElement("a");return a.setAttribute("href","#"),a.className="medium-editor-toobar-close",a.innerHTML="&times;",r.setAttribute("href","#"),r.className="medium-editor-toobar-save",r.innerHTML="&#10003;",e.setAttribute("type","text"),e.className="medium-editor-toolbar-input",e.setAttribute("placeholder",this.options.anchorInputPlaceholder),n.setAttribute("type","checkbox"),n.className="medium-editor-toolbar-anchor-target",o.innerHTML=this.options.anchorInputCheckboxLabel,o.insertBefore(n,o.firstChild),s.setAttribute("type","checkbox"),s.className="medium-editor-toolbar-anchor-button",i.innerHTML="Button",i.insertBefore(s,i.firstChild),t.className="medium-editor-toolbar-form",t.id="medium-editor-toolbar-form-anchor-"+this.id,t.appendChild(e),t.appendChild(r),t.appendChild(a),this.options.anchorTarget&&t.appendChild(o),this.options.anchorButton&&t.appendChild(i),t},bindSelect:function(){var t,e,o=this;for(this.checkSelectionWrapper=function(t){return t.stopPropagation(),clearTimeout(e),!o.options.disableAnchorForm&&t&&o.clickingIntoArchorForm(t)?!1:void(e=setTimeout(function(){o.checkSelection()},10))},this.on(this.options.ownerDocument.documentElement,"mouseup",this.checkSelectionWrapper),t=0;t<this.elements.length;t+=1)this.on(this.elements[t],"keyup",this.checkSelectionWrapper),this.on(this.elements[t],"blur",this.checkSelectionWrapper),this.on(this.elements[t],"mouseup",this.checkSelectionWrapper);return this},insertHTML:function(e){var o,n,i,s,a,r;if(this.options.ownerDocument.queryCommandSupported("insertHTML"))try{return this.options.ownerDocument.execCommand("insertHTML",!1,e)}catch(l){}if(o=t.getSelection(),o.getRangeAt&&o.rangeCount){for(n=o.getRangeAt(0),n.deleteContents(),i=this.options.ownerDocument.createElement("div"),i.innerHTML=e,s=this.options.ownerDocument.createDocumentFragment();i.firstChild;)a=i.firstChild,r=s.appendChild(a);n.insertNode(s),r&&(n=n.cloneRange(),n.setStartAfter(r),n.collapse(!0),o.removeAllRanges(),o.addRange(n))}},bindDragDrop:function(){var t,o,n,i,s,a=this;if(!a.options.imageDragging)return this;for(o="medium-editor-dragover",n=function(t){t.preventDefault(),t.dataTransfer.dropEffect="copy","dragover"===t.type?this.classList.add(o):this.classList.remove(o)},i=function(t){var n;t.preventDefault(),t.stopPropagation(),n=Array.prototype.slice.call(t.dataTransfer.files,0),n.some(function(t){if(t.type.match("image")){var o,n;o=new FileReader,o.readAsDataURL(t),n="medium-img-"+ +new Date,a.insertHTML('<img class="medium-image-loading" id="'+n+'" />'),o.onload=function(){var t=e.getElementById(n);t&&(t.removeAttribute("id"),t.removeAttribute("class"),t.src=o.result)}}}),this.classList.remove(o)},t=0;t<this.elements.length;t+=1)s=this.elements[t],this.on(s,"dragover",n),this.on(s,"dragleave",n),this.on(s,"drop",i);return this},stopSelectionUpdates:function(){this.preventSelectionUpdates=!0},startSelectionUpdates:function(){this.preventSelectionUpdates=!1},checkSelection:function(){var t,e;return this.preventSelectionUpdates||this.keepToolbarAlive===!0||this.options.disableToolbar||(t=this.options.contentWindow.getSelection(),!this.options.updateOnEmptySelection&&""===t.toString().trim()||this.options.allowMultiParagraphSelection===!1&&this.hasMultiParagraphs()||this.selectionInContentEditableFalse()?this.options.staticToolbar?this.anchorForm&&"block"===this.anchorForm.style.display&&(this.setToolbarButtonStates(),this.showToolbarActions()):this.hideToolbarActions():(e=this.getSelectionElement(),!e||e.getAttribute("data-disable-toolbar")?this.options.staticToolbar||this.hideToolbarActions():this.checkSelectionElement(t,e))),this},clickingIntoArchorForm:function(t){var e=this;return t.type&&"blur"===t.type.toLowerCase()&&t.relatedTarget&&t.relatedTarget===e.anchorInput?!0:!1},hasMultiParagraphs:function(){var t=c.call(this).replace(/<[\S]+><\/[\S]+>/gim,""),e=t.match(/<(p|h[0-6]|blockquote)>([\s\S]*?)<\/(p|h[0-6]|blockquote)>/g);return e?e.length:0},checkSelectionElement:function(t,e){var o,n,i,a=0;if(this.selection=t,this.selectionRange=this.selection.getRangeAt(0),this.options.standardizeSelectionStart&&this.selectionRange.startContainer.nodeValue&&this.selectionRange.startOffset===this.selectionRange.startContainer.nodeValue.length&&(n=s(this.getSelectionElement(),this.selectionRange.startContainer,this.options.ownerDocument))){for(a=0;0===n.nodeValue.substr(a,1).trim().length;)a+=1;i=this.options.ownerDocument.createRange(),i.setStart(n,a),i.setEnd(this.selectionRange.endContainer,this.selectionRange.endOffset),this.selection.removeAllRanges(),this.selection.addRange(i),this.selectionRange=i}for(o=0;o<this.elements.length;o+=1)if(this.elements[o]===e)return void this.setToolbarButtonStates().setToolbarPosition().showToolbarActions();this.options.staticToolbar||this.hideToolbarActions()},traverseUp:function(t,e){do{if(1===t.nodeType){if(e(t))return t;if(t.getAttribute("data-medium-element"))return!1}t=t.parentNode}while(t);return!1},findMatchingSelectionParent:function(t){var e,o,n=this.options.contentWindow.getSelection();return 0===n.rangeCount?!1:(e=n.getRangeAt(0),o=e.commonAncestorContainer,this.traverseUp(o,t))},getSelectionElement:function(){return this.findMatchingSelectionParent(function(t){return t.getAttribute("data-medium-element")})},selectionInContentEditableFalse:function(){return this.findMatchingSelectionParent(function(t){return t&&"#text"!==t.nodeName&&"false"===t.getAttribute("contenteditable")})},setToolbarPosition:function(){var t,e,o,n=this.options.ownerDocument.documentElement&&this.options.ownerDocument.documentElement.scrollTop||this.options.ownerDocument.body.scrollTop,i=this.elements[0],s=i.getBoundingClientRect(),a=s.top+n,r=50,l=this.options.contentWindow.getSelection(),c=this.options.diffLeft-this.toolbar.offsetWidth/2,h=this.toolbar.offsetWidth/2,u=s.left+s.width/2;return null===l.focusNode?this:(this.showToolbar(),this.options.staticToolbar?(this.options.stickyToolbar?n>a+this.elements[0].offsetHeight-this.toolbar.offsetHeight?this.toolbar.style.top=a+this.elements[0].offsetHeight+"px":n>a-this.toolbar.offsetHeight?(this.toolbar.classList.add("sticky-toolbar"),this.toolbar.style.top="0px"):(this.toolbar.classList.remove("sticky-toolbar"),this.toolbar.style.top=a-this.toolbar.offsetHeight+"px"):this.toolbar.style.top=a-this.toolbar.offsetHeight+"px",this.toolbar.style.left=this.options.toolbarAlign?"left"===this.options.toolbarAlign?s.left+"px":"center"===this.options.toolbarAlign?u-h+"px":s.right-this.toolbar.offsetWidth+"px":u-h+"px"):l.isCollapsed||(t=l.getRangeAt(0),e=t.getBoundingClientRect(),o=(e.left+e.right)/2,e.top<r?(this.toolbar.classList.add("medium-toolbar-arrow-over"),this.toolbar.classList.remove("medium-toolbar-arrow-under"),this.toolbar.style.top=r+e.bottom-this.options.diffTop+this.options.contentWindow.pageYOffset-this.toolbar.offsetHeight+"px"):(this.toolbar.classList.add("medium-toolbar-arrow-under"),this.toolbar.classList.remove("medium-toolbar-arrow-over"),this.toolbar.style.top=e.top+this.options.diffTop+this.options.contentWindow.pageYOffset-this.toolbar.offsetHeight+"px"),this.toolbar.style.left=h>o?c+h+"px":this.options.contentWindow.innerWidth-o<h?this.options.contentWindow.innerWidth+c-h+"px":c+o+"px"),this.hideAnchorPreview(),this)},setToolbarButtonStates:function(){return this.commands.forEach(function(t){"function"==typeof t.deactivate&&t.deactivate()}.bind(this)),this.checkActiveButtons(),this},checkActiveButtons:function(){for(var t=Array.prototype.slice.call(this.elements),e=this.getSelectedParentElement(),o=function(t){"function"==typeof t.checkState?t.checkState(e):"function"==typeof t.isActive&&!t.isActive()&&t.shouldActivate(e)&&t.activate()};void 0!==e.tagName&&-1===this.parentElements.indexOf(e.tagName.toLowerCase)&&(this.activateButton(e.tagName.toLowerCase()),this.commands.forEach(o.bind(this)),-1===t.indexOf(e));)e=e.parentNode},activateButton:function(t){var e=this.toolbar.querySelector('[data-element="'+t+'"]');null===e||e.classList.contains(this.options.activeButtonClass)||e.classList.add(this.options.activeButtonClass)},bindButtons:function(){return this.setFirstAndLastItems(this.toolbar.querySelectorAll("button")),this},setFirstAndLastItems:function(t){return t.length>0&&(t[0].className+=" "+this.options.firstButtonClass,t[t.length-1].className+=" "+this.options.lastButtonClass),this},execAction:function(t,e){t.indexOf("append-")>-1?(this.execFormatBlock(t.replace("append-","")),this.setToolbarPosition(),this.setToolbarButtonStates()):"anchor"===t?this.options.disableAnchorForm||this.triggerAnchorAction(e):"image"===t?this.options.ownerDocument.execCommand("insertImage",!1,this.options.contentWindow.getSelection()):(this.options.ownerDocument.execCommand(t,!1,null),this.setToolbarPosition(),0===t.indexOf("justify")&&this.setToolbarButtonStates())},showForm:function(t){this.toolbarActions.style.display="none",this.saveSelection();var o=e.getElementById(t);o.style.display="block",this.setToolbarPosition(),this.keepToolbarAlive=!0},hideForm:function(t){var o=e.getElementById(t.id);o.style.display="none",this.showToolbarActions(),this.setToolbarPosition(),r.call(this,this.savedSelection)},rangeSelectsSingleNode:function(t){var e=t.startContainer;return e===t.endContainer&&e.hasChildNodes()&&t.endOffset===t.startOffset+1},getSelectedParentElement:function(){var t=null,e=this.selectionRange;return t=this.rangeSelectsSingleNode(e)&&3!==e.startContainer.childNodes[e.startOffset].nodeType?e.startContainer.childNodes[e.startOffset]:3===e.startContainer.nodeType?e.startContainer.parentNode:e.startContainer},triggerAnchorAction:function(){var t=this.getSelectedParentElement();return t.tagName&&"a"===t.tagName.toLowerCase()?this.options.ownerDocument.execCommand("unlink",!1,null):this.anchorForm&&("block"===this.anchorForm.style.display?this.showToolbarActions():this.showAnchorForm()),this},execFormatBlock:function(t){var e=this.getSelectionData(this.selection.anchorNode);if("blockquote"===t&&e.el&&"blockquote"===e.el.parentNode.tagName.toLowerCase())return this.options.ownerDocument.execCommand("outdent",!1,null);if(e.tagName===t&&(t="p"),this.isIE){if("blockquote"===t)return this.options.ownerDocument.execCommand("indent",!1,t);t="<"+t+">"}return this.options.ownerDocument.execCommand("formatBlock",!1,t)},getSelectionData:function(t){var e;for(t&&t.tagName&&(e=t.tagName.toLowerCase());t&&-1===this.parentElements.indexOf(e);)t=t.parentNode,t&&t.tagName&&(e=t.tagName.toLowerCase());return{el:t,tagName:e}},getFirstChild:function(t){for(var e=t.firstChild;null!==e&&1!==e.nodeType;)e=e.nextSibling;return e},isToolbarShown:function(){return this.toolbar&&this.toolbar.classList.contains("medium-editor-toolbar-active")},showToolbar:function(){this.toolbar&&!this.isToolbarShown()&&(this.toolbar.classList.add("medium-editor-toolbar-active"),this.onShowToolbar&&this.onShowToolbar())},hideToolbar:function(){this.isToolbarShown()&&(this.toolbar.classList.remove("medium-editor-toolbar-active"),this.onHideToolbar&&this.onHideToolbar())},hideToolbarActions:function(){this.commands.forEach(function(t){t.onHide&&"function"==typeof t.onHide&&t.onHide()}),this.keepToolbarAlive=!1,this.hideToolbar()},showToolbarActions:function(){var t=this;this.anchorForm&&(this.anchorForm.style.display="none"),this.toolbarActions.style.display="block",this.keepToolbarAlive=!1,this.delay(function(){t.showToolbar()})},saveSelection:function(){this.savedSelection=a.call(this)},restoreSelection:function(){r.call(this,this.savedSelection)},showAnchorForm:function(t){this.anchorForm&&(this.toolbarActions.style.display="none",this.saveSelection(),this.anchorForm.style.display="block",this.setToolbarPosition(),this.keepToolbarAlive=!0,this.anchorInput.focus(),this.anchorInput.value=t||"")},bindAnchorForm:function(){if(!this.anchorForm)return this;var t=this.anchorForm.querySelector("a.medium-editor-toobar-close"),e=this.anchorForm.querySelector("a.medium-editor-toobar-save"),o=this;return this.on(this.anchorForm,"click",function(t){t.stopPropagation(),o.keepToolbarAlive=!0}),this.on(this.anchorInput,"keyup",function(t){var e,n=null;t.keyCode===p.ENTER?(t.preventDefault(),e=o.options.anchorTarget&&o.anchorTarget.checked?"_blank":"_self",o.options.anchorButton&&o.anchorButton.checked&&(n=o.options.anchorButtonClass),o.createLink(this,e,n)):t.keyCode===p.ESCAPE&&(t.preventDefault(),o.showToolbarActions(),r.call(o,o.savedSelection))}),this.on(e,"click",function(t){var e,n=null;t.preventDefault(),e=o.options.anchorTarget&&o.anchorTarget.checked?"_blank":"_self",o.options.anchorButton&&o.anchorButton.checked&&(n=o.options.anchorButtonClass),o.createLink(o.anchorInput,e,n)},!0),this.on(this.anchorInput,"click",function(t){t.stopPropagation(),o.keepToolbarAlive=!0}),this.on(this.options.ownerDocument.body,"click",function(t){t.target===o.anchorForm||i(o.anchorForm,t.target)||i(o.toolbarActions,t.target)||(o.keepToolbarAlive=!1,o.checkSelection())},!0),this.on(this.options.ownerDocument.body,"focus",function(t){t.target===o.anchorForm||i(o.anchorForm,t.target)||i(o.toolbarActions,t.target)||(o.keepToolbarAlive=!1,o.checkSelection())},!0),this.on(t,"click",function(t){t.preventDefault(),o.showToolbarActions(),r.call(o,o.savedSelection)}),this},hideAnchorPreview:function(){this.anchorPreview.classList.remove("medium-editor-anchor-preview-active")},showAnchorPreview:function(t){if(this.anchorPreview.classList.contains("medium-editor-anchor-preview-active")||t.getAttribute("data-disable-preview"))return!0;var e,o,n=this,i=40,s=t.getBoundingClientRect(),a=(s.left+s.right)/2;return n.anchorPreview.querySelector("i").textContent=t.attributes.href.value,e=n.anchorPreview.offsetWidth/2,o=n.options.diffLeft-e,n.observeAnchorPreview(t),n.anchorPreview.classList.add("medium-toolbar-arrow-over"),n.anchorPreview.classList.remove("medium-toolbar-arrow-under"),n.anchorPreview.style.top=Math.round(i+s.bottom-n.options.diffTop+this.options.contentWindow.pageYOffset-n.anchorPreview.offsetHeight)+"px",n.anchorPreview.style.left=e>a?o+e+"px":this.options.contentWindow.innerWidth-a<e?this.options.contentWindow.innerWidth+o-e+"px":o+a+"px",this.anchorPreview&&!this.anchorPreview.classList.contains("medium-editor-anchor-preview-active")&&this.anchorPreview.classList.add("medium-editor-anchor-preview-active"),this
},observeAnchorPreview:function(t){var e=this,o=(new Date).getTime(),n=!0,i=function(){o=(new Date).getTime(),n=!0},s=function(t){t.relatedTarget&&/anchor-preview/.test(t.relatedTarget.className)||(n=!1)},a=setInterval(function(){if(n)return!0;var r=(new Date).getTime()-o;r>e.options.anchorPreviewHideDelay&&(e.hideAnchorPreview(),clearInterval(a),e.off(e.anchorPreview,"mouseover",i),e.off(e.anchorPreview,"mouseout",s),e.off(t,"mouseover",i),e.off(t,"mouseout",s))},200);this.on(e.anchorPreview,"mouseover",i),this.on(e.anchorPreview,"mouseout",s),this.on(t,"mouseover",i),this.on(t,"mouseout",s)},createAnchorPreview:function(){var t=this,e=this.options.ownerDocument.createElement("div");return e.id="medium-editor-anchor-preview-"+this.id,e.className="medium-editor-anchor-preview",e.innerHTML=this.anchorPreviewTemplate(),this.options.elementsContainer.appendChild(e),this.on(e,"click",function(){t.anchorPreviewClickHandler()}),e},anchorPreviewTemplate:function(){return'<div class="medium-editor-toolbar-anchor-preview" id="medium-editor-toolbar-anchor-preview">    <i class="medium-editor-toolbar-anchor-preview-inner"></i></div>'},anchorPreviewClickHandler:function(){if(!this.options.disableAnchorForm&&this.activeAnchor){var t=this,e=this.options.ownerDocument.createRange(),o=this.options.contentWindow.getSelection();e.selectNodeContents(t.activeAnchor),o.removeAllRanges(),o.addRange(e),this.delay(function(){t.activeAnchor&&t.showAnchorForm(t.activeAnchor.attributes.href.value),t.keepToolbarAlive=!1})}this.hideAnchorPreview()},editorAnchorObserver:function(t){var e=this,o=!0,n=function(){o=!1,e.off(e.activeAnchor,"mouseout",n)};if(t.target&&"a"===t.target.tagName.toLowerCase()){if(!/href=["']\S+["']/.test(t.target.outerHTML)||/href=["']#\S+["']/.test(t.target.outerHTML))return!0;if(this.isToolbarShown())return!0;this.activeAnchor=t.target,this.on(this.activeAnchor,"mouseout",n),this.delay(function(){o&&e.showAnchorPreview(t.target)})}},bindAnchorPreview:function(){var t,e=this;for(this.editorAnchorObserverWrapper=function(t){e.editorAnchorObserver(t)},t=0;t<this.elements.length;t+=1)this.on(this.elements[t],"mouseover",this.editorAnchorObserverWrapper);return this},checkLinkFormat:function(t){var e=/^(https?|ftps?|rtmpt?):\/\/|mailto:/;return(e.test(t)?"":"http://")+t},setTargetBlank:function(t){var e;if(t=t||l.call(this),"a"===t.tagName.toLowerCase())t.target="_blank";else for(t=t.getElementsByTagName("a"),e=0;e<t.length;e+=1)t[e].target="_blank"},setButtonClass:function(t){var e,o,n=l.call(this),i=t.split(" ");if("a"===n.tagName.toLowerCase())for(o=0;o<i.length;o+=1)n.classList.add(i[o]);else for(n=n.getElementsByTagName("a"),e=0;e<n.length;e+=1)for(o=0;o<i.length;o+=1)n[e].classList.add(i[o])},createLink:function(t,e,o){var n,i;if(this.createLinkInternal(t.value,e,o),this.options.targetBlank||"_blank"===e||o)for(i=this.options.ownerDocument.createEvent("HTMLEvents"),i.initEvent("input",!0,!0,this.options.contentWindow),n=0;n<this.elements.length;n+=1)this.elements[n].dispatchEvent(i);this.checkSelection(),this.showToolbarActions(),t.value=""},createLinkInternal:function(t,e,o){return t&&0!==t.trim().length?(r.call(this,this.savedSelection),this.options.checkLinkFormat&&(t=this.checkLinkFormat(t)),this.options.ownerDocument.execCommand("createLink",!1,t),(this.options.targetBlank||"_blank"===e)&&this.setTargetBlank(),void(o&&this.setButtonClass(o))):void this.hideToolbarActions()},positionToolbarIfShown:function(){this.isToolbarShown()&&this.setToolbarPosition()},bindWindowActions:function(){var t=this;return this.options.staticToolbar&&this.options.stickyToolbar&&this.on(this.options.contentWindow,"scroll",function(){t.positionToolbarIfShown()},!0),this.on(this.options.contentWindow,"resize",function(){t.handleResize()}),this.bindBlur(),this},activate:function(){this.isActive||this.setup()},deactivate:function(){var t;if(this.isActive){for(this.isActive=!1,void 0!==this.toolbar&&(this.options.elementsContainer.removeChild(this.anchorPreview),this.options.elementsContainer.removeChild(this.toolbar),delete this.toolbar,delete this.anchorPreview),t=0;t<this.elements.length;t+=1)this.elements[t].removeAttribute("contentEditable"),this.elements[t].removeAttribute("data-medium-element");this.removeAllEvents()}},htmlEntities:function(t){return String(t).replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},bindPaste:function(){var t,e=this;for(this.pasteWrapper=function(t){var o,n,i="",s="text/html",a="text/plain";if(this.classList.remove("medium-editor-placeholder"),!e.options.forcePlainText&&!e.options.cleanPastedHTML)return this;if(e.options.contentWindow.clipboardData&&void 0===t.clipboardData&&(t.clipboardData=e.options.contentWindow.clipboardData,s="Text",a="Text"),t.clipboardData&&t.clipboardData.getData&&!t.defaultPrevented){if(t.preventDefault(),e.options.cleanPastedHTML&&t.clipboardData.getData(s))return e.cleanPaste(t.clipboardData.getData(s));if(e.options.disableReturn||this.getAttribute("data-disable-return"))i=e.htmlEntities(t.clipboardData.getData(a)),e.insertHTML(i);else{for(o=t.clipboardData.getData(a).split(/[\r\n]/g),n=0;n<o.length;n+=1)""!==o[n]&&(i+="<p>"+e.htmlEntities(o[n])+"</p>");e.insertHTML(i)}}},t=0;t<this.elements.length;t+=1)this.on(this.elements[t],"paste",this.pasteWrapper);return this},setPlaceholders:function(){return!this.options.disablePlaceholders&&this.elements&&this.elements.length&&this.elements.forEach(function(t){this.activatePlaceholder(t),this.on(t,"blur",this.placeholderWrapper.bind(this)),this.on(t,"keypress",this.placeholderWrapper.bind(this))}.bind(this)),this},cleanPaste:function(t){var e,o,n,i=this.getSelectionElement(),s=/<p|<br|<div/.test(t),a=[[new RegExp(/<[^>]*docs-internal-guid[^>]*>/gi),""],[new RegExp(/<\/b>(<br[^>]*>)?$/gi),""],[new RegExp(/<span class="Apple-converted-space">\s+<\/span>/g)," "],[new RegExp(/<br class="Apple-interchange-newline">/g),"<br>"],[new RegExp(/<span[^>]*(font-style:italic;font-weight:bold|font-weight:bold;font-style:italic)[^>]*>/gi),'<span class="replace-with italic bold">'],[new RegExp(/<span[^>]*font-style:italic[^>]*>/gi),'<span class="replace-with italic">'],[new RegExp(/<span[^>]*font-weight:bold[^>]*>/gi),'<span class="replace-with bold">'],[new RegExp(/&lt;(\/?)(i|b|a)&gt;/gi),"<$1$2>"],[new RegExp(/&lt;a\s+href=(&quot;|&rdquo;|&ldquo;|“|”)([^&]+)(&quot;|&rdquo;|&ldquo;|“|”)&gt;/gi),'<a href="$2">']];for(e=0;e<a.length;e+=1)t=t.replace(a[e][0],a[e][1]);if(s)for(o=t.split("<br><br>"),this.pasteHTML("<p>"+o.join("</p><p>")+"</p>"),this.options.ownerDocument.execCommand("insertText",!1,"\n"),o=i.querySelectorAll("a,p,div,br"),e=0;e<o.length;e+=1)switch(n=o[e],n.tagName.toLowerCase()){case"a":this.options.targetBlank&&this.setTargetBlank(n);break;case"p":case"div":this.filterCommonBlocks(n);break;case"br":this.filterLineBreak(n)}else this.pasteHTML(t)},pasteHTML:function(t){var e,o,n,i,s=this.options.ownerDocument.createDocumentFragment();for(s.appendChild(this.options.ownerDocument.createElement("body")),i=s.querySelector("body"),i.innerHTML=t,this.cleanupSpans(i),e=i.querySelectorAll("*"),n=0;n<e.length;n+=1)o=e[n],o.removeAttribute("class"),o.removeAttribute("style"),o.removeAttribute("dir"),"meta"===o.tagName.toLowerCase()&&o.parentNode.removeChild(o);this.insertHTML(i.innerHTML.replace(/&nbsp;/g," "))},isCommonBlock:function(t){return t&&("p"===t.tagName.toLowerCase()||"div"===t.tagName.toLowerCase())},filterCommonBlocks:function(t){/^\s*$/.test(t.textContent)&&t.parentNode.removeChild(t)},filterLineBreak:function(t){this.isCommonBlock(t.previousElementSibling)?t.parentNode.removeChild(t):!this.isCommonBlock(t.parentNode)||t.parentNode.firstChild!==t&&t.parentNode.lastChild!==t?1===t.parentNode.childElementCount&&this.removeWithParent(t):t.parentNode.removeChild(t)},removeWithParent:function(t){t&&t.parentNode&&(t.parentNode.parentNode&&1===t.parentNode.childElementCount?t.parentNode.parentNode.removeChild(t.parentNode):t.parentNode.removeChild(t.parentNode))},cleanupSpans:function(t){var e,o,n,i=t.querySelectorAll(".replace-with"),s=function(t){return t&&"#text"!==t.nodeName&&"false"===t.getAttribute("contenteditable")};for(e=0;e<i.length;e+=1)o=i[e],n=this.options.ownerDocument.createElement(o.classList.contains("bold")?"b":"i"),n.innerHTML=o.classList.contains("bold")&&o.classList.contains("italic")?"<i>"+o.innerHTML+"</i>":o.innerHTML,o.parentNode.replaceChild(n,o);for(i=t.querySelectorAll("span"),e=0;e<i.length;e+=1){if(o=i[e],this.traverseUp(o,s))return!1;/^\s*$/.test()?o.parentNode.removeChild(o):o.parentNode.replaceChild(this.options.ownerDocument.createTextNode(o.textContent),o)}}}}(window,document);
